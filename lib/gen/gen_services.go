//go:build ignore

package main

import (
	"context"
	"fmt"
	"log"
	"os"
	"strings"

	krpcgo "github.com/atburke/krpc-go"
	"github.com/atburke/krpc-go/internal"
	"github.com/atburke/krpc-go/lib/gen"
	"github.com/atburke/krpc-go/lib/utils"
	"github.com/dave/jennifer/jen"
)

const genWarning = "Code generated by gen_services.go. DO NOT EDIT."

func main() {
	ctx := context.Background()
	client := krpcgo.NewKRPCClient(krpcgo.KRPCClientConfig{
		RPCOnly: true,
	})
	if err := client.Connect(ctx); err != nil {
		log.Fatalf("Failed to connect to server. Is KSP running with a kRPC server?\n%v", err)
	}
	krpc := internal.NewBasicKRPC(client)
	services, err := krpc.GetServices()
	if err != nil {
		log.Fatal(err)
	}

	for _, service := range services.Services {
		serviceName := strings.ToLower(service.Name)
		serviceDocs, err := utils.ParseXMLDocumentation(service.Documentation, "From service docs: ")
		if err != nil {
			log.Fatal(err)
		}

		f := jen.NewFile(serviceName)
		f.PackageComment(gen.WrapDocComment(fmt.Sprintf(
			"Package %v provides methods to invoke procedures in the %v service.\n\n%v",
			serviceName, service.Name, serviceDocs,
		)))
		fmt.Printf("Generating service %q\n", service.Name)
		f.Comment(genWarning)
		f.Line()

		if err := gen.GenerateService(f, service); err != nil {
			log.Fatal(err)
		}
		dest := fmt.Sprintf("%v/%v.gen.go", serviceName, serviceName)
		if err := os.MkdirAll(serviceName, os.ModeDir|0755); err != nil {
			log.Fatal(err)
		}
		fmt.Printf("Writing service definition to %v\n", dest)
		if err := f.Save(dest); err != nil {
			log.Fatal(err)
		}
	}
}
